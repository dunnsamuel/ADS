---
title: "Tidying Data in R"
author: "Sam Dunn"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


```{r libraries, include=FALSE, warning=FALSE,message=FALSE}
library(tidyr)
library(dplyr)
library(broom)
```

Below we read in data from the website. Use square brackets around ahyperlink to make it a hyperlink in markdown. [Mike Byerly. 2016. Alaska commercial salmon catches by management region (1886- 1997). Gulf of Alaska Data Portal. df35b.304.2.] (https://knb.ecoinformatics.org/#view/df35b.304.2)
```{r Load Data }
catch_df <- read.csv(url("https://knb.ecoinformatics.org/knb/d1/mn/v2/object/df35b.302.1",method = "libcurl"),stringsAsFactors = FALSE) #read in data from site
head(catch_df)

```

```{r eval=FALSE, include=FALSE}
library(RSQLite)
data(mtcars)
cars.df<-mtcars
conn <- dbConnect(SQLite(),'cars.df')
#dbWriteTable(conn, "cars", mtcars)
dbListTables(conn)
dbListFields(conn, "cars")
```
```{r eval=FALSE, include=FALSE}
efficient.df<-dbGetQuery(conn, "SELECT * FROM cars WHERE mpg > 20")

```


keyobard shortcut  ctrl+shift+m => %>% 

Go back to using catch df

startswith, endswith, contains  in select command
```{r Pipe Operators}
catch_df<-catch_df %>% 
  select(-All,-notesRegCode)

```


```{r}
catch_df<-catch_df %>% 
  gather(key="species",value="catch", -Region, -Year) #tranposes df
```
Exlude grouping variables so they dont get transposed...exclude sing "-"


Rename a column
```{r}
catch_df<-catch_df %>% 
  rename(catch_thousands=catch)# %>% #new name=old name
  
  
  
```

```{r}
catch_integers<-as.integer(catch_df$catch_thousands)
i=which(is.na(catch_integers)=="TRUE")

catch_df$catch_thousands[i]
```


```{r}
catch_df <-catch_df %>% 
  mutate(catch_thousands=ifelse(catch_thousands=="I",1,catch_thousands)) %>% #conditional test to rename bad value
  mutate(catch_thousands=as.integer(catch_thousands))%>% 
  rename(catchTHOUSADS=catch_thousands)
  
head(catch_df)  
```

#Split , Apply Combine
```{r}
catch_summarised<-catch_df %>% 
  group_by(Region) %>% 
  summarise(catch_mean=mean(catchTHOUSADS))

catch_summarised
```

```{r}
catch_range<-catch_df %>% 
  group_by(Region,Year,species) %>% 
  summarise(catchlow=range(catchTHOUSADS)[1],
            catchhigh=range(catchTHOUSADS)[2],
            catchmed=median(catchTHOUSADS),
            numobs=n()) %>% filter(species=="Chinook") %>% 
  arrange(desc(Year))
catch_range
```



```{r}
catch_aov<-catch_df %>% 
  group_by(Year) %>% 
  do(tidy(aov(data=.,catchTHOUSADS~species))) %>% 
  filter(Year<="1997" & Year>="1990")

catch_aov
```

##Joins##
Left joins return all left columns and any matching right columns that have matching key.  Have a key for every table!  In this case it is our region code column.  Left joins are the standrad case for joins....under rare circumstancs are Right or full joins done.
```{r}
regdef<-read.csv("df35b.303.1.csv",stringsAsFactors = F)
regdef<-regdef %>% 
  select(code,mgmtArea) %>% 
  rename(Region=code)

joined_tab<-left_join(catch_df,regdef, by="Region") #left join!  
```

c() is the *concatenator* function. Instead  renaming code to Region like I did I could list both keys in the same order as the arguments in the join.  c("Region"="code")

# Visulaization#
GGPlot and leaflet for plots and maps, respectively.  Related question....how do I use bibtex files in markdown?  W're building a webpage!  Using github as the host


